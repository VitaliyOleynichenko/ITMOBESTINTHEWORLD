**Signal Logger Project**

This project monitors the table `T_MNLZ2_SIGNAL` for the record with `ID = 355` and `DESCR = 'МГР1.Позиция.'`. It retrieves the `VAL` and `DT_SET` fields every 5 seconds and logs them to a text file and displays them in a web interface.

---

# File Structure

* `db_connect.php`
  Contains Oracle DB connection: `$username`, `$password`, `$connection_string`, creates `$conn` via `oci_connect($username,$password,$connection_string,'AL32UTF8')`.

* `logger.php`
  A CLI/PHP script executed every 5 seconds (e.g., via cron or `watch`) that:

  1. Queries `T_MNLZ2_SIGNAL` for row where `ID = 355 AND DESCR = 'МГР1.Позиция.'`:

     ```sql
     SELECT VAL, TO_CHAR(DT_SET,'YYYY-MM-DD HH24:MI:SS') AS DT_SET_STR
       FROM T_MNLZ2_SIGNAL
      WHERE ID = 355 AND DESCR = 'МГР1.Позиция.'
     ```
  2. Appends to log file `signal_log.txt`:

     ```text
     Дата и время: 2025-05-15 12:34:56  позиция мгр: 12345
     ```

* `signal_log.txt`
  Plain text log, created alongside script, recorded entries.

* `index.php`
  Web page that reads `signal_log.txt` and displays the entries in an HTML list/table.

* `style.css`
  Basic styling for `index.php`.

# Implementation Details

## db\_connect.php

```php
<?php
// db_connect.php

$username          = 'YOUR_DB_USER';
$password          = 'YOUR_DB_PASS';
$connection_string = 'HOST:1521/SERVICE';

$conn = oci_connect($username, $password, $connection_string, 'AL32UTF8');
if (!$conn) {
    $e = oci_error();
    exit('DB connection failed: ' . htmlspecialchars($e['message']));
}
```

## logger.php

```php
<?php
// logger.php - run every 5 seconds

require __DIR__ . '/db_connect.php';

// Query current value
$sql = "SELECT VAL, TO_CHAR(DT_SET, 'YYYY-MM-DD HH24:MI:SS') AS DT_SET_STR
          FROM T_MNLZ2_SIGNAL
         WHERE ID = 355
           AND DESCR = 'МГР1.Позиция.'";
$stid = oci_parse($conn, $sql);
ici_execute($stid);
$row = oci_fetch_assoc($stid);
oci_free_statement($stid);
oci_close($conn);

if ($row) {
    $line = sprintf(
      "Дата и время: %s  позиция мгр: %s\n",
      $row['DT_SET_STR'],
      $row['VAL']
    );
    file_put_contents(__DIR__ . '/signal_log.txt', $line, FILE_APPEND | LOCK_EX);
}
```

## index.php

```php
<?php
// index.php
$logFile = __DIR__ . '/signal_log.txt';
$entries = [];
if (file_exists($logFile)) {
    $entries = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
}
?>
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Signal Logger</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Лог значений МГР1.Позиция.</h1>
  <table>
    <thead>
      <tr>
        <th>#</th><th>Запись</th>
      </tr>
    </thead>
    <tbody>
      <?php foreach ($entries as $i => $line): ?>
      <tr>
        <td><?= $i+1 ?></td>
        <td><?= htmlspecialchars($line) ?></td>
      </tr>
      <?php endforeach; ?>
    </tbody>
  </table>
</body>
</html>
```

## style.css

```css
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}
h1 {
  margin-bottom: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
}
th {
  background: #f0f0f0;
}
```

**Запуск**: настроить cron на `* * * * * php /path/to/logger.php` (каждые 1 минуту) или `watch -n 5 php logger.php`

---

Теперь у вас есть **полный** проект: подключение, сбор данных, лог-файл и веб-интерфейс.


Файл api/log_signal.php
Этот скрипт при каждом вызове:

Подключается к Oracle.

Читает из T_MNLZ2_SIGNAL строку с ID = 355 и DESCR = 'МГР1.Позиция.'.

Добавляет в конец файла signal_log.txt новую строку с форматом:

yaml
Копировать код
Дата и время: 2025-05-15 12:34:56  позиция мгр: 12345
php
Копировать код
<?php
// api/log_signal.php

header('Content-Type: application/json; charset=UTF-8');
ini_set('display_errors',1);
error_reporting(E_ALL);

// 1) Подключаемся к БД
require __DIR__ . '/../db_connect.php';
if (!$conn) {
  http_response_code(500);
  echo json_encode(['error'=>'DB connect failed']);
  exit;
}

// 2) Получаем текущее значение
$sql = "
  SELECT VAL,
         TO_CHAR(DT_SET,'YYYY-MM-DD HH24:MI:SS') AS DT_SET_STR
    FROM T_MNLZ2_SIGNAL
   WHERE ID = 355
     AND DESCR = 'МГР1.Позиция.'
";
$stid = oci_parse($conn, $sql);
oci_execute($stid);

$row = oci_fetch_assoc($stid);
oci_free_statement($stid);
oci_close($conn);

if (!$row) {
  echo json_encode(['error'=>'No data']);
  exit;
}

// 3) Формируем строку лога
$line = sprintf(
  "Дата и время: %s  позиция мгр: %s\n",
  $row['DT_SET_STR'],
  $row['VAL']
);

// 4) Пишем в файл
$logFile = __DIR__ . '/../signal_log.txt';
file_put_contents($logFile, $line, FILE_APPEND | LOCK_EX);

// 5) Возвращаем запись клиенту
echo json_encode(['logged' => $line], JSON_UNESCAPED_UNICODE);
2. Файл index.php
php
Копировать код
<?php
// index.php
?>
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Signal Logger</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>Логи сигнала МГР1.Позиция.</h1>
  <div id="status">Статус: <em>ожидание...</em></div>
  <table id="logTable">
    <thead>
      <tr><th>#</th><th>Запись</th></tr>
    </thead>
    <tbody id="logBody">
      <!-- сюда будем вставлять строки лога -->
    </tbody>
  </table>

  <script>
  // 1) Функция — получить весь лог-файл и отрисовать
  async function loadLog() {
    try {
      const resp = await fetch('api/get_signal_log.php');
      const lines = await resp.json(); // массив строк
      const tbody = document.getElementById('logBody');
      tbody.innerHTML = '';
      lines.forEach((line, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${line}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('status').textContent = 'Статус: данные обновлены';
    } catch(e) {
      console.error('Ошибка загрузки лога:', e);
      document.getElementById('status').textContent = 'Статус: ошибка при загрузке';
    }
  }

  // 2) Функция — вызвать логгер и тут же обновить таблицу
  async function tick() {
    try {
      console.group('Tick');
      console.log('Запрашиваем логгирование…');
      const resp = await fetch('api/log_signal.php', { method:'POST' });
      const js = await resp.json();
      console.log('Ответ log_signal:', js);
    } catch(e) {
      console.error('Ошибка log_signal:', e);
    }
    await loadLog();
    console.groupEnd();
  }

  // 3) При загрузке страницы сразу подгружаем существующий лог
  document.addEventListener('DOMContentLoaded', () => {
    loadLog();
    // и запускаем tick() каждые 5 секунд
    setInterval(tick, 5000);
  });
  </script>
</body>
</html>
3. Файл api/get_signal_log.php
Чтобы отображать в браузере уже записанные строки:

php
Копировать код
<?php
// api/get_signal_log.php

header('Content-Type: application/json; charset=UTF-8');
$logFile = __DIR__ . '/../signal_log.txt';
$lines = [];

if (file_exists($logFile)) {
  // читаем все строки и убираем пустые
  $lines = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
}

// возвращаем JSON-массив строк
echo json_encode($lines, JSON_UNESCAPED_UNICODE);
4. Файл style.css
css
Копировать код
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}
h1 {
  margin-bottom: 10px;
}
#status {
  margin-bottom: 12px;
  font-style: italic;
}
#logTable {
  width: 100%;
  border-collapse: collapse;
}
#logTable th,
#logTable td {
  border: 1px solid #ccc;
  padding: 6px 8px;
}
#logTable thead {
  background: #f0f0f0;
}
#logTable tbody tr:nth-child(even) {
  background: #fafafa;
}
Как это работает
Когда вы открываете index.php, клиентский JS сразу выполняет loadLog() и показывает уже имеющиеся записи.

Затем каждую 5-ю секунду вызывается tick(), которое:

POST’ом зовёт api/log_signal.php → скрипт опрашивает БД и дописывает новую строчку в signal_log.txt.

После этого — асинхронно — обновляет таблицу (loadLog()).

Таким образом, пока у вас открыт index.php, каждые 5 секунд из БД будут сниматься данные и тут же показываться в браузере.
















ChatGPT может допускать ошибки. Проверьте важную информацию. См. настройки c
